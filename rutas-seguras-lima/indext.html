<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutas Seguras Lima</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Rutas Seguras Lima</h1>
            <p>Encuentra el camino más seguro en Lima</p>
        </header>
        
        <div class="content">
            <div class="sidebar">
                <form id="route-form">
                    <div class="form-group">
                        <label for="origin">Punto de inicio:</label>
                        <input type="text" id="origin" placeholder="Ingresa tu ubicación de origen" required>
                    </div>
                    <div class="form-group">
                        <label for="destination">Destino:</label>
                        <input type="text" id="destination" placeholder="Ingresa tu destino" required>
                    </div>
                    <button type="submit">Buscar Ruta Segura</button>
                </form>
                
                <div class="route-info" id="route-info" style="display: none;">
                    <h3>Información de la Ruta</h3>
                    <div class="security-level">
                        <span>Nivel de seguridad:</span>
                        <div class="security-level-bar">
                            <div class="security-level-fill" id="security-level-fill"></div>
                        </div>
                        <span id="security-percentage">80%</span>
                    </div>
                    <p><strong>Distancia:</strong> <span id="route-distance">0</span> km</p>
                    <p><strong>Tiempo estimado:</strong> <span id="route-time">0</span> min</p>
                    
                    <h4 style="margin-top: 15px;">Incidentes cercanos reportados</h4>
                    <div class="incident-list" id="incident-list">
                        <!-- Los incidentes se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="loading" id="loading">Buscando la ruta más segura...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Datos mockeados para simular la base de datos PostgreSQL
        const mockedSecurityData = {
            // Distritos con nivel de seguridad (0-100)
            districts: {
                'Miraflores': 85,
                'San Isidro': 90,
                'Surco': 75,
                'Barranco': 70,
                'San Borja': 80,
                'La Molina': 78,
                'Jesús María': 72,
                'Lince': 65,
                'San Miguel': 68,
                'Magdalena': 70,
                'Pueblo Libre': 69,
                'Lima Centro': 50,
                'Rimac': 40,
                'San Juan de Lurigancho': 35,
                'Villa El Salvador': 38,
                'San Juan de Miraflores': 42,
                'La Victoria': 45,
                'Ate': 48,
                'Callao': 40
            },
            
            // Puntos de interés para seguridad
            securityPoints: [
                {
                    name: 'Comisaría Miraflores',
                    lat: -12.1197,
                    lng: -77.0297,
                    type: 'police',
                    securityLevel: 'high'
                },
                {
                    name: 'Comisaría San Isidro',
                    lat: -12.0977,
                    lng: -77.0365,
                    type: 'police',
                    securityLevel: 'high'
                },
                {
                    name: 'Centro Comercial Larcomar',
                    lat: -12.1317,
                    lng: -77.0276,
                    type: 'commercial',
                    securityLevel: 'high'
                },
                {
                    name: 'Parque Kennedy',
                    lat: -12.1219,
                    lng: -77.0297,
                    type: 'park',
                    securityLevel: 'medium'
                },
                {
                    name: 'Plaza San Miguel',
                    lat: -12.0769,
                    lng: -77.0825,
                    type: 'commercial',
                    securityLevel: 'medium'
                },
                {
                    name: 'Zona de alto riesgo - La Victoria',
                    lat: -12.0650,
                    lng: -77.0150,
                    type: 'risk',
                    securityLevel: 'low'
                },
                {
                    name: 'Zona monitoreada - San Borja',
                    lat: -12.1019,
                    lng: -76.9975,
                    type: 'monitored',
                    securityLevel: 'high'
                },
                {
                    name: 'Patrullaje constante - Surco',
                    lat: -12.1450,
                    lng: -76.9917,
                    type: 'police',
                    securityLevel: 'high'
                },
                {
                    name: 'Zona de precaución - Callao',
                    lat: -12.0500,
                    lng: -77.1200,
                    type: 'risk',
                    securityLevel: 'low'
                },
                {
                    name: 'Zona Iluminada - San Isidro',
                    lat: -12.0950,
                    lng: -77.0410,
                    type: 'lighting',
                    securityLevel: 'high'
                }
            ],
            
            // Incidentes reportados
            incidents: [
                {
                    type: 'Robo',
                    description: 'Robo de celular',
                    lat: -12.1335,
                    lng: -77.0241,
                    date: '2025-05-01'
                },
                {
                    type: 'Asalto',
                    description: 'Asalto a transeúnte',
                    lat: -12.0630,
                    lng: -77.0120,
                    date: '2025-05-02'
                },
                {
                    type: 'Sospechoso',
                    description: 'Persona sospechosa merodeando',
                    lat: -12.0950,
                    lng: -77.0510,
                    date: '2025-05-03'
                },
                {
                    type: 'Robo',
                    description: 'Intento de robo de vehículo',
                    lat: -12.0530,
                    lng: -77.1100,
                    date: '2025-05-03'
                },
                {
                    type: 'Vandalismo',
                    description: 'Daño a propiedad pública',
                    lat: -12.1150,
                    lng: -77.0197,
                    date: '2025-05-04'
                }
            ]
        };

        // Coordenadas de Lima, Perú
        const LIMA_CENTER = [-12.0464, -77.0428];
        const DEFAULT_ZOOM = 12;
        
        // Inicialización del mapa
        let map, originMarker, destinationMarker, routeLayer;
        
        // Inicializar el mapa cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEventListeners();
            loadSecurityPoints();
        });
        
        function initMap() {
            // Crear el mapa y configurar la vista
            map = L.map('map').setView(LIMA_CENTER, DEFAULT_ZOOM);
            
            // Añadir capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Añadir leyenda al mapa
            const legend = L.control({ position: 'bottomright' });
            
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Leyenda</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #27ae60;"></div>
                        <span>Alta seguridad</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>Seguridad media</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Baja seguridad</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Ruta recomendada</span>
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
        }
        
        function setupEventListeners() {
            // Evento para el formulario de búsqueda de ruta
            document.getElementById('route-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const origin = document.getElementById('origin').value;
                const destination = document.getElementById('destination').value;
                
                if (origin && destination) {
                    findSecureRoute(origin, destination);
                }
            });
        }
        
        function loadSecurityPoints() {
            // Cargar puntos de seguridad desde los datos mockeados
            mockedSecurityData.securityPoints.forEach(point => {
                let markerColor;
                let markerIcon;
                
                // Determinar color y icono según el nivel de seguridad y tipo
                switch (point.securityLevel) {
                    case 'high':
                        markerColor = '#27ae60';
                        break;
                    case 'medium':
                        markerColor = '#f39c12';
                        break;
                    case 'low':
                        markerColor = '#e74c3c';
                        break;
                }
                
                switch (point.type) {
                    case 'police':
                        markerIcon = '🚓';
                        break;
                    case 'commercial':
                        markerIcon = '🏬';
                        break;
                    case 'park':
                        markerIcon = '🌳';
                        break;
                    case 'risk':
                        markerIcon = '⚠️';
                        break;
                    case 'monitored':
                        markerIcon = '📹';
                        break;
                    case 'lighting':
                        markerIcon = '💡';
                        break;
                    default:
                        markerIcon = '📍';
                }
                
                // Crear marcador con popup
                const marker = L.marker([point.lat, point.lng]).addTo(map);
                
                marker.bindPopup(`
                    <div class="marker-popup">
                        <h3>${markerIcon} ${point.name}</h3>
                        <p>Tipo: ${getPointTypeName(point.type)}</p>
                        <p class="marker-security security-${point.securityLevel}">
                            Nivel de seguridad: ${getSecurityLevelName(point.securityLevel)}
                        </p>
                    </div>
                `);
            });
            
            // Cargar incidentes desde los datos mockeados
            mockedSecurityData.incidents.forEach(incident => {
                const marker = L.circle([incident.latitude, incident.longitude], {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.5,
                    radius: 150
                }).addTo(map);
                
                marker.bindPopup(`
                    <div class="marker-popup">
                        <h3>⚠️ ${incident.type}</h3>
                        <p>${incident.description}</p>
                        <p>Reportado: ${formatDate(incident.date)}</p>
                    </div>
                `);
            });
        }
        
        function getPointTypeName(type) {
            const types = {
                'police': 'Comisaría/Patrullaje',
                'commercial': 'Centro Comercial',
                'park': 'Parque/Área Verde',
                'risk': 'Zona de Riesgo',
                'monitored': 'Zona Monitoreada',
                'lighting': 'Zona Bien Iluminada'
            };
            
            return types[type] || type;
        }
        
        function getSecurityLevelName(level) {
            const levels = {
                'high': 'Alta',
                'medium': 'Media',
                'low': 'Baja'
            };
            
            return levels[level] || level;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-PE');
        }
        
        function findSecureRoute(origin, destination) {
            // Mostrar indicador de carga
            document.getElementById('loading').style.display = 'block';
            
            // Simulamos un tiempo de carga para simular la consulta a la base de datos
            setTimeout(() => {
                // Función que simula el geocoding para obtener coordenadas
                const originCoords = mockGeocode(origin);
                const destCoords = mockGeocode(destination);
                
                // Limpiar marcadores y rutas previas
                if (originMarker) map.removeLayer(originMarker);
                if (destinationMarker) map.removeLayer(destinationMarker);
                if (routeLayer) map.removeLayer(routeLayer);
                
                // Crear marcadores para origen y destino
                originMarker = L.marker(originCoords).addTo(map);
                originMarker.bindPopup(`<b>Origen:</b> ${origin}`).openPopup();
                
                destinationMarker = L.marker(destCoords).addTo(map);
                destinationMarker.bindPopup(`<b>Destino:</b> ${destination}`);
                
                // Generar una ruta "segura" simulada
                const route = generateMockRoute(originCoords, destCoords);
                
                // Dibujar la ruta en el mapa
                routeLayer = L.polyline(route.path, { color: '#3498db', weight: 5 }).addTo(map);
                
                // Ajustar vista para ver la ruta completa
                map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                
                // Actualizar información de la ruta
                updateRouteInfo(route);
                
                // Ocultar indicador de carga
                document.getElementById('loading').style.display = 'none';
                
                // Mostrar panel de información de ruta
                document.getElementById('route-info').style.display = 'block';
            }, 1500); // Simular tiempo de carga de 1.5 segundos
        }
        
        function mockGeocode(placeName) {
            // Esta función simula el proceso de geocodificación
            // En una aplicación real, esto se haría con una API de geocodificación
            
            // Mapa simulado de lugares a coordenadas
            const placeCoordinates = {
                'miraflores': [-12.1219, -77.0297],
                'san isidro': [-12.0977, -77.0365],
                'surco': [-12.1450, -76.9917],
                'barranco': [-12.1495, -77.0219],
                'la molina': [-12.0867, -76.9055],
                'san borja': [-12.1019, -76.9975],
                'jesús maría': [-12.0705, -77.0517],
                'lince': [-12.0833, -77.0333],
                'san miguel': [-12.0789, -77.0825],
                'magdalena': [-12.0889, -77.0717],
                'pueblo libre': [-12.0717, -77.0633],
                'lima centro': [-12.0464, -77.0428],
                'rimac': [-12.0292, -77.0428],
                'san juan de lurigancho': [-12.0031, -77.0081],
                'villa el salvador': [-12.2136, -76.9319],
                'san juan de miraflores': [-12.1550, -76.9700],
                'la victoria': [-12.0650, -77.0150],
                'ate': [-12.0258, -76.9178],
                'callao': [-12.0500, -77.1200],
                'jockey plaza': [-12.0847, -76.9750],
                'parque kennedy': [-12.1219, -77.0297],
                'plaza san miguel': [-12.0769, -77.0825],
                'aeropuerto jorge chávez': [-12.0219, -77.1144],
                'universidad de lima': [-12.0836, -76.9700],
                'universidad católica': [-12.0711, -77.0796],
                'plaza de armas': [-12.0464, -77.0329],
                'estadio nacional': [-12.0672, -77.0333],
                'megaplaza': [-11.9958, -77.0600],
                'wong la molina': [-12.0867, -76.9150],
                'real plaza salaverry': [-12.0894, -77.0522]
            };
            
            // Buscar el lugar ignorando mayúsculas/minúsculas
            const normalizedPlaceName = placeName.toLowerCase();
            
            // Verificar si el lugar existe en nuestro mapa simulado
            for (const [key, coords] of Object.entries(placeCoordinates)) {
                if (normalizedPlaceName.includes(key)) {
                    return coords;
                }
            }
            
            // Si no se encuentra, devolver una coordenada aleatoria en Lima
            return [
                LIMA_CENTER[0] + (Math.random() - 0.5) * 0.1,
                LIMA_CENTER[1] + (Math.random() - 0.5) * 0.1
            ];
        }
        
        function generateMockRoute(origin, destination) {
            // Esta función simula la generación de una ruta "segura"
            // En una aplicación real, esto se haría con un algoritmo que considere
            // los datos de seguridad almacenados en PostgreSQL
            
            // Genere puntos intermedios para simular una ruta
            const numPoints = Math.floor(Math.random() * 3) + 3; // 3-5 puntos intermedios
            const intermediatePoints = [];
            
            for (let i = 0; i < numPoints; i++) {
                const ratio = (i + 1) / (numPoints + 1);
                const lat = origin[0] + (destination[0] - origin[0]) * ratio;
                const lng = origin[1] + (destination[1] - origin[1]) * ratio;
                
                // Añadir un poco de variación para que no sea una línea recta
                const latVariation = (Math.random() - 0.5) * 0.015;
                const lngVariation = (Math.random() - 0.5) * 0.015;
                
                intermediatePoints.push([lat + latVariation, lng + lngVariation]);
            }
            
            // Construir el camino completo
            const path = [origin, ...intermediatePoints, destination];
            
            // Calcular distancia aproximada (en km)
            let distance = 0;
            for (let i = 1; i < path.length; i++) {
                distance += calculateDistance(path[i-1], path[i]);
            }
            
            // Calcular tiempo estimado (aproximadamente 4 km/h caminando)
            const timeMinutes = Math.round(distance / 4 * 60);
            
            // Calcular nivel de seguridad
            const securityLevel = calculateRouteSecurityLevel(path);
            
            // Encontrar incidentes cercanos a la ruta
            const nearbyIncidents = findNearbyIncidents(path);
            
            return {
                path,
                distance: distance.toFixed(1),
                timeMinutes,
                securityLevel,
                nearbyIncidents
            };
        }
        
        function calculateDistance(point1, point2) {
            // Función para calcular la distancia aproximada entre dos puntos (en km)
            // Usando la fórmula de Haversine
            const R = 6371; // Radio de la Tierra en km
            const dLat = deg2rad(point2[0] - point1[0]);
            const dLon = deg2rad(point2[1] - point1[1]);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(deg2rad(point1[0])) * Math.cos(deg2rad(point2[0])) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        function calculateRouteSecurityLevel(path) {
            // Esta función simula el cálculo del nivel de seguridad de una ruta
            // basado en los distritos por los que pasa
            let totalSecurity = 0;
            let districtsCount = 0;
            
            // Para cada punto de la ruta, buscar el distrito más cercano
            path.forEach(point => {
                const district = findNearestDistrict(point);
                if (district && mockedSecurityData.districts[district]) {
                    totalSecurity += mockedSecurityData.districts[district];
                    districtsCount++;
                }
            });
            
            // Si no se encontró ningún distrito, usar un valor predeterminado
            if (districtsCount === 0) return 50;
            
            return Math.round(totalSecurity / districtsCount);
        }
        
        function findNearestDistrict(point) {
            // Esta función simula encontrar el distrito más cercano a un punto
            // En una aplicación real, se usaría un algoritmo de geolocalización más preciso
            
            // Coordenadas aproximadas de los centros de los distritos
            const districtCenters = {
                'Miraflores': [-12.1219, -77.0297],
                'San Isidro': [-12.0977, -77.0365],
                'Surco': [-12.1450, -76.9917],
                'Barranco': [-12.1495, -77.0219],
                'San Borja': [-12.1019, -76.9975],
                'La Molina': [-12.0867, -76.9055],
                'Jesús María': [-12.0705, -77.0517],
                'Lince': [-12.0833, -77.0333],
                'San Miguel': [-12.0789, -77.0825],
                'Magdalena': [-12.0889, -77.0717],
                'Pueblo Libre': [-12.0717, -77.0633],
                'Lima Centro': [-12.0464, -77.0428],
                'Rimac': [-12.0292, -77.0428],
                'San Juan de Lurigancho': [-12.0031, -77.0081],
                'Villa El Salvador': [-12.2136, -76.9319],
                'San Juan de Miraflores': [-12.1550, -76.9700],
                'La Victoria': [-12.0650, -77.0150],
                'Ate': [-12.0258, -76.9178],
                'Callao': [-12.0500, -77.1200]
            };
            
            let nearestDistrict = null;
            let smallestDistance = Infinity;
            
            // Encontrar el distrito más cercano
            for (const [district, center] of Object.entries(districtCenters)) {
                const distance = calculateDistance(point, center);
                if (distance < smallestDistance) {
                    smallestDistance = distance;
                    nearestDistrict = district;
                }
            }
            
            return nearestDistrict;
        }
        
        function findNearbyIncidents(path) {
            // Esta función encuentra incidentes cercanos a la ruta
            const nearbyIncidents = [];
            const MAX_DISTANCE_KM = 1; // Distancia máxima en km para considerar un incidente como "cercano"
            
            // Para cada incidente, verificar si está cerca de algún punto de la ruta
            mockedSecurityData.incidents.forEach(incident => {
                const incidentPoint = [incident.lat, incident.lng];
                
                // Verificar la distancia mínima a cualquier punto de la ruta
                let minDistance = Infinity;
                path.forEach(routePoint => {
                    const distance = calculateDistance(incidentPoint, routePoint);
                    minDistance = Math.min(minDistance, distance);
                });
                
                // Si está lo suficientemente cerca, añadirlo a la lista
                if (minDistance <= MAX_DISTANCE_KM) {
                    nearbyIncidents.push(incident);
                }
            });
            
            return nearbyIncidents;
        }
        
        function updateRouteInfo(route) {
            // Actualizar la información de la ruta en el panel lateral
            document.getElementById('route-distance').textContent = route.distance;
            document.getElementById('route-time').textContent = route.timeMinutes;
            
            // Actualizar el nivel de seguridad
            const securityFill = document.getElementById('security-level-fill');
            const securityPercentage = document.getElementById('security-percentage');
            
            securityFill.style.width = `${route.securityLevel}%`;
            securityPercentage.textContent = `${route.securityLevel}%`;
            
            // Establecer el color según el nivel de seguridad
            if (route.securityLevel >= 70) {
                securityFill.style.backgroundColor = '#27ae60'; // Verde para alta seguridad
            } else if (route.securityLevel >= 50) {
                securityFill.style.backgroundColor = '#f39c12'; // Amarillo para seguridad media
            } else {
                securityFill.style.backgroundColor = '#e74c3c'; // Rojo para baja seguridad
            }
            
            // Mostrar incidentes cercanos
            const incidentList = document.getElementById('incident-list');
            incidentList.innerHTML = '';
            
            if (route.nearbyIncidents.length === 0) {
                incidentList.innerHTML = '<div class="incident-item">No se encontraron incidentes cercanos</div>';
            } else {
                route.nearbyIncidents.forEach(incident => {
                    const incidentItem = document.createElement('div');
                    incidentItem.className = 'incident-item';
                    incidentItem.innerHTML = `
                        <strong>${incident.type}:</strong> ${incident.description} 
                        <span style="color: #777;">(${formatDate(incident.date)})</span>
                    `;
                    incidentList.appendChild(incidentItem);
                });
            }
        }
    </script>
</body>
</html>